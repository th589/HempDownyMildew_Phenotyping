---
title: "04 Detached Leaf Analysis"
author: "Taylere Herrmann"
date: "`r Sys.Date()`"
output: html_document
---

# Detached Leaf Rating by Eye - 8dpi

```{r, message=FALSE}
# Loading additional libraries:
library(tidyverse)
library(emmeans)
library(car)
library(nlme)
```

## Transformation

```{r}
detached_df <- read_csv("Detached_average.csv")

detached_df <- detached_df %>% 
  mutate(across(c(X0dpi, X5dpi, X6dpi, X7dpi, X8dpi, X9dpi), 
                ~asin(sqrt(.x/100)), 
                .names = "a{.col}")) #transformed columns have an "a" infront

#write_csv(detached_df, file ="detached_transformed.csv")

# Calculate mean and standard error for each timepoint by accession
detached_summary <- detached_df %>% 
  group_by(Accession) %>% 
  summarise(across (starts_with("X"),
                    list(mean = ~round(mean(.x, na.rm = TRUE), 4),
                         stderr = ~round(sd(.x, na.rm = TRUE)/ sqrt(n()), 4)), 
                    .names = "{.col}_{.fn}"))

# Make a separate data frame with just 8dpi info
detached_8dpi_summary <- detached_summary %>%
  select(Accession, X8dpi_mean, X8dpi_stderr)
```

## Diagnostics

### Batch effect testing  

```{r}
# Without batch
m0 <- lme(
  aX8dpi ~ Accession,
  random = ~1 | Rep,
  data = detached_df,
  method = "REML"
)

# With batch
m1 <- lme(
  aX8dpi ~ Accession,
  random = list(
    Batch = ~1, # batch variation
    Rep = ~1 | Batch), # rep nested within batch to match exp structure
  data = detached_df,
  method = "REML"
)

anova(m0, m1)
```

ANOVA is performing a likelihood ratio test (LRT) asking, does adding a batch level random effect significant improve model fit?

|  |  |  |
|-------------------|------------------|-----------------------------------|
| Likelihood ratio w/ batch | 18.68 | the model with batch explains more structure in the data than the model without |
| P value m1 w/ batch | \< 0.0001 | batch contributes significant variance to disease severity |
| Delta AIC | 17 | strong support (AIC \> 10 = strong support) |

Conclusion: Disease severity differed significantly among experimental batches, indicating batch level variation influenced observed disease outcomes.

### Unequal variance testing 

```{r}
mod <- lme(
  aX8dpi ~ Accession,
  random = list(
    Batch = ~1,
    Rep = ~1| Batch),
  data = detached_df,
  method = "REML"
)
```

```{r}
# Plotting residuals vs fitted values (diagnose heterogeneity visually)
plot(
  fitted(mod),
  resid(mod),
  xlab = "Fitted values",
  ylab = "Residuals"
)
abline(h = 0, lty = 2)
```
```{r}
# absolute residuals vs fitted values 
plot(
  fitted(mod),
  abs(resid(mod)),
  xlab = "Fitted values",
  ylab = "|Residuals|"
)
```
```{r}
# Does variance increase with severity?
detached_df %>%
  group_by(Accession) %>%
  summarise(
    mean = mean(X8dpi, na.rm = TRUE),
    sd = sd(X8dpi, na.rm = TRUE)
  ) %>%
  ggplot(aes(mean, sd)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE)
```

```{r}
# residual spread vs mean severity (binning)
diag_df <- detached_df %>%
  mutate(
    fitted = fitted(mod),
    resid = resid(mod),
    abs_resid = abs(resid)
  ) %>%
  mutate(
    severity_bin = cut(
      fitted,
      breaks = quantile(fitted, probs = seq(0, 1, 0.25), na.rm = TRUE),
      include.lowest = TRUE
    )
  )

diag_df %>%
  group_by(severity_bin) %>%
  summarise(
    mean_fitted = mean(fitted),
    resid_sd = sd(resid),
    .groups = "drop"
  )
```
Residual variance increases with disease severity. This increase occurs across all bins, with bin 4 (high severity) having the highest residual varaince

```{r}
# Levene Test
leveneTest(resid(mod) ~ severity_bin, data = diag_df)
```
Levene's test is significant, indicating that residual variance differs across severity bins and residual spread is not constant and heterogeneity exists. 

### Heteroscedasitcy -- modeling entry specific variance
```{r}
#m_entry_het <- lme(
  #aX8dpi ~ Accession,
  #random = list(
    #Batch = ~1,
    #Rep = ~1| Batch),
  #weights = varIdent(form = ~1 | Accession),
  #data = detached_df,
  #method = "REML",
  #control = lmeControl(msMaxIter = 50, opt = "optim"))

#summary(m_entry_het)
#VarCorr(m_entry_het)
```
Result: Error in MEestimate(lmeSt, grps) :Singularity in backsolve at level 0, block 1
The model tired to estimate parameters that the data cannot support (accession means, *entry specific variances, batch variance, rep variance, and residual structure, from 3 replicates per accession/entry). 

## Linear Mixed Model

```{r}
# Fit LMM
model <- lme(
  aX8dpi ~ Accession,
  random = list(
    Batch = ~1, 
    Rep = ~1 | Batch), # rep nested in Batch
  data = detached_df,
  method = "REML"
)

#emms for each accession
emm <- emmeans(model, ~ Accession)

#convert to data frame
emm_df <- as.data.frame(emm)

#Look at emm values
emm_df %>% arrange(desc(emmean))
write_csv(emm_df, file = "8dpi/detached_emmeans.csv")
```

```{r}
VarCorr(model)
```
Variance decomposition:
Batch: 0.036
Rep: 0.007
Residual: 0.061

## Dunnett - Post Hoc

```{r}
run_dunnett <- function(emm, ref_accession) {
  
  dun <- contrast(
    emm,
    method = "dunnett",
    ref = ref_accession,
    adjust = "none"
  ) %>%
    as.data.frame() %>%
    mutate(
      significant = ifelse(p.value <= 0.05, "Yes", "No"),
      Accession = str_remove(contrast, paste0(" - ", ref_accession)),
      Reference = ref_accession
    ) %>%
    select(Accession, p.value, significant, Reference)
  
  # Print count (keeps your reporting behavior)
  message(
    "Number of accessions significantly different from ",
    ref_accession, ": ",
    sum(dun$significant == "Yes")
  )
  
  return(dun)
}
```

```{r}
dunnett_G33312  <- run_dunnett(emm, "G33312")
dunnett_S27     <- run_dunnett(emm, "Santhica 27")
```

-   Number of accessions sig. diff from G33312 (susceptible control) --\> 65
-   Number of accessions sig. diff from Santhica 27 (resistant control) --\> 19

```{r}
clean_accession <- function(x) {
  x %>%
    str_trim() %>%
    str_remove_all("\\(|\\)")
}

detached_8dpi_summary <- detached_8dpi_summary %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33312 <- dunnett_G33312 %>%
  mutate(Accession = clean_accession(Accession))

dunnett_S27 <- dunnett_S27 %>%
  mutate(Accession = clean_accession(Accession))
```

```{r}
merged_df_detached <- detached_8dpi_summary %>%
  left_join(
    dunnett_G33312 %>%
      rename(
        G33312_p.value = p.value,
        G33312_significant = significant
      ) %>%
      select(-Reference),
    by = "Accession"
  ) %>%
  left_join(
    dunnett_S27 %>%
      rename(
        G33379_p.value = p.value,
        G33379_significant = significant
      ) %>%
      select(-Reference),
    by = "Accession"
  ) %>%
  mutate(
    across(c(X8dpi_mean, X8dpi_stderr), round, 4),
    across(c(G33312_p.value, G33379_p.value), round, 4)
  )
```

```{r}
write_csv(merged_df_detached, "8dpi/Detached_Dunnett.csv")
```

## Visualize Susceptible Control Significance (G33312, 8dpi)

Showing estimated mean disease severity (back transformed to %) with dunnett significance of biologically susceptible control (G 33312)

```{r}
# Back-transform emmeans to % disease
emm_df <- as.data.frame(emm) %>%
  mutate(
    X8dpi_mean = (sin(emmean))^2 * 100,
    X8dpi_stderr = ((sin(emmean + SE))^2 - (sin(emmean - SE))^2)/2  # approximate SE in %
  )

# Read Dunnett results
dunnett <- read.csv("8dpi/Detached_Dunnett.csv")

# Merge Dunnett significance for control (e.g., G33312)
df_fig1 <- emm_df %>%
  left_join(dunnett %>% select(Accession, G33312_significant), by = "Accession") %>%
  mutate(Group = case_when(
    G33312_significant == "Yes" ~ "Significant",
    TRUE ~ "Not significant"
  ))

# Reorder legend
df_fig1$Group <- factor(df_fig1$Group, levels = c("Significant", "Not significant"))

# Order bars by mean severity
df_fig1 <- df_fig1 %>% arrange(X8dpi_mean)

# Define fill colors
fill_colors <- c("Significant" = "#D8817A", "Not significant" = "#D9D9D9")

# Dynamically position asterisks above bars
df_fig1 <- df_fig1 %>%
  mutate(
    # Add small offset above error bar
    sig_y = X8dpi_mean + X8dpi_stderr + 3,  # adjust for more/less spacing
    sig_label = ifelse(Group == "Significant", "\u2731", "") # Unicode star
  )

# Plot
p1 <- ggplot(df_fig1, aes(x = reorder(Accession, X8dpi_mean), y = X8dpi_mean, fill = Group)) +
  geom_bar(stat = "identity", alpha = 0.80) +
  geom_errorbar(aes(ymin = X8dpi_mean - X8dpi_stderr, ymax = X8dpi_mean + X8dpi_stderr), 
                width = 0.3, 
                color = "#000000",
                alpha = 0.6) +
  geom_text(aes(y = sig_y, label = sig_label), color = "#D8817A", size = 2) +  
  scale_fill_manual(
    values = fill_colors,
    labels = c("Significant" = "Significant", 
               "Not significant" = "Not Significant")
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 4, color = "black"),
    axis.title = element_text(size = 12),
    legend.position = c(0, 1),
    legend.justification = c("left", "top"),
    legend.box.just = "left",
    legend.margin = margin(20, 10, 10, 20),
    legend.key.size = unit(0.5, "cm"),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  ) +
  labs(
    x = "Entry",
    y = "Disease Severity (0â€“100%)",
    fill = "Statistical Difference from Susceptible Control"
  ) +
  ylim(0, 100)

# Add arrow for susceptible control
g33312_index <- which(levels(reorder(df_fig1$Accession, df_fig1$X8dpi_mean)) == "G33312")

p1 <- p1 +
  annotate("segment",
           x = g33312_index, xend = g33312_index,
           y = 76, yend = 66,
           arrow = arrow(length = unit(0.2, "cm")),
           color = "black")

plot(p1)

ggsave("8dpi/Figures/Detached_8dpi.tiff", plot = p1, dpi = 600, width = 6.5, height = 4.5, units = "in", compression = "lzw")
```

## BLUP calculation (best linear unbiased prediction, 8dpi on arcsin transformed data)

```{r}
# Fit Blup model
detached_blup_model <- lme(
  aX8dpi ~ 1,
  random = list(
    Accession = ~1,
    Batch = ~1,
    Rep = ~1 | Batch
  ),
  data = detached_df,
  method = "REML"
)

# Extract BLUPs for Accession
blup_df <- ranef(detached_blup_model)$Accession %>%
  as.data.frame() %>%
  rename(blup_aX8dpi = `(Intercept)`) %>%
  mutate(Accession = rownames(ranef(detached_blup_model)$Accession))

# Calculate per-accession means
summary_means <- detached_df %>%
  group_by(Accession) %>%
  summarise(
    mean_X8dpi = mean(X8dpi, na.rm = TRUE),
    mean_aX8dpi = mean(aX8dpi, na.rm = TRUE)
  )

# Combine means and BLUPs
blup_summary <- summary_means %>%
  left_join(blup_df, by = "Accession") %>%
  dplyr::select(Accession, mean_X8dpi, mean_aX8dpi, blup_aX8dpi)

# Export to CSV
write.csv(blup_summary, "8dpi/Detached_BLUP.csv", row.names = FALSE)
```

```{r}
VarCorr(detached_blup_model)
```
In detached blup model the variance decomposition is:
Batch = 0.055 
Rep = 0.07
Accession = ~0
Residual = ~0

