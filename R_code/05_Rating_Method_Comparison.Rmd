---
title: "05 Rating Method Comparison"
author: "Taylere Herrmann"
date: "`r Sys.Date()`"
output: html_document
---

```{r, message=FALSE}
library(tidyverse)
library(nlme)
library(emmeans)
#library(multcomp) later in comparison section
#library(patchwork) later in plot section
```

# Observed disease patterns (Raw data)

-   Raw severity
-   resistant categories
-   correlations
-   use raw obs. for descriptive summaries and correlations

## Load raw 8dpi data

```{r, message=FALSE}
#Load raw 8dpi data 
BB_df <- read_csv("BB_average.csv")
plot_df <- read_csv("Plot_average.csv")
detached_df <- read_csv("Detached_average.csv")
```

```{r}
# Arcsine-square root transform (8 dpi severity, %)
BB_df <- BB_df %>%
  mutate(aX8dpi = asin(sqrt(X8dpi / 100)))

plot_df <- plot_df %>%
  mutate(aX8dpi = asin(sqrt(X8dpi / 100)))

detached_df <- detached_df %>%
  mutate(aX8dpi = asin(sqrt(X8dpi / 100)))
```

## Identify consistently low disease entries

```{r}
# Identify accessions with consistently low disease 
# Long-form raw data
BB_long <- BB_df %>% select(Accession, Rep, X8dpi) %>% rename(BB = X8dpi)
plot_long <- plot_df %>% select(Accession, Rep, X8dpi) %>% rename(Plot = X8dpi)
detached_long <- detached_df %>% select(Accession, Rep, X8dpi) %>% rename(Detached = X8dpi)

flag_method <- function(df, varname) {
  df %>%
    group_by(Accession) %>%
    summarise(
      all_below_5 = all(.data[[varname]] <= 5, na.rm = TRUE),
      all_below_1 = all(.data[[varname]] <= 1, na.rm = TRUE),
      all_zero    = all(.data[[varname]] == 0, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    rename_with(~ paste0(varname, "_", .), -Accession)
}

BB_flags       <- flag_method(BB_long, "BB")
plot_flags     <- flag_method(plot_long, "Plot")
detached_flags <- flag_method(detached_long, "Detached")

final_table <- BB_flags %>%
  full_join(plot_flags, by = "Accession") %>%
  full_join(detached_flags, by = "Accession") %>%
  mutate(
    all_methods_below_5 = BB_all_below_5 & Plot_all_below_5 & Detached_all_below_5,
    all_methods_below_1 = BB_all_below_1 & Plot_all_below_1 & Detached_all_below_1,
    all_methods_zero    = BB_all_zero & Plot_all_zero & Detached_all_zero
  )

write_csv(final_table, "8dpi/Observed_Resistance_Flags.csv")
```

## Identify consistently high disease entries

```{r}
# Compute mean severity per accession (raw values)
BB_means <- BB_df %>%
  group_by(Accession) %>%
  summarise(BB_mean = mean(X8dpi, na.rm = TRUE), .groups = "drop")

plot_means <- plot_df %>%
  group_by(Accession) %>%
  summarise(Plot_mean = mean(X8dpi, na.rm = TRUE), .groups = "drop")

detached_means <- detached_df %>%
  group_by(Accession) %>%
  summarise(Detached_mean = mean(X8dpi, na.rm = TRUE), .groups = "drop")

# Merge and compute overall average severity
all_means <- BB_means %>%
  full_join(plot_means, by = "Accession") %>%
  full_join(detached_means, by = "Accession") %>%
  rowwise() %>%
  mutate(Average_Severity = mean(c(BB_mean, Plot_mean, Detached_mean), na.rm = TRUE)) %>%
  ungroup()

# Top 10 susceptible accessions
top10_susceptible <- all_means %>%
  arrange(desc(Average_Severity)) %>%
  slice_head(n = 10)

write_csv(top10_susceptible, "8dpi/Top10_Observed_Susceptible.csv")
```

## Visualize entries by rating method

```{r,message=FALSE}
# Load Dunnett data
detached <- read_csv("8dpi/Detached_Dunnett.csv")
plot_eye <- read_csv("8dpi/Plot_Dunnett.csv")
bb <- read_csv("8dpi/BB_Dunnett.csv")

# Add a rating method column and extract mean severity at 8dpi
detached <- detached %>%
  select(Accession, X8dpi_mean) %>%
  mutate(Method = "Detached")

plot_eye <- plot_eye %>%
  select(Accession, X8dpi_mean) %>%
  mutate(Method = "Plot")

bb <- bb %>%
  select(Accession, X8dpi_mean) %>%
  mutate(Method = "Blackbird")

# Combine all three datasets
all_data <- bind_rows(detached, plot_eye, bb)
```

```{r}
# Reorder accessions by average severity (low to high)
accession_order <- all_data %>%
  group_by(Accession) %>%
  summarize(avg_severity = mean(X8dpi_mean, na.rm = TRUE)) %>%
  arrange(avg_severity) %>%
  pull(Accession)
    # To organize the accessions by disease severity, the average X8dpi_mean is calculated across all three rating methods for each accession, and accessions are sorted from lowest to highest mean severity 

all_data$Accession <- factor(all_data$Accession, levels = accession_order)

# Legend order 
all_data$Method <- factor(all_data$Method, levels = c("Blackbird", "Plot", "Detached"))

# Legend labels
method_labels <- c(
  "Blackbird" = "Leaf Discs Rated by Blackbird Convolutional Neural Network",
  "Plot" = "Leaf Discs Rated Visually",
  "Detached" = "Detached Leaves Rated Visually")

# colors and point shapes
method_grays <- c(
  "Blackbird" = "#7C6BAF",
  "Plot" = "#3AAFB9",
  "Detached" = "#D8817A")

method_shapes <- c(
   "Blackbird" = 16,
  "Plot" = 17,
  "Detached" = 15) #circle, triangle, square
```

```{r, warning = FALSE}
# Plot
all_ratings_plot <- ggplot(all_data, aes(x = Accession, y = X8dpi_mean)) +
  geom_line(aes(group = Accession), color = "gray50", size = 0.3, alpha = 0.6) +
  geom_point(aes(color = Method, shape = Method), 
             position = position_dodge(width = 0.5), 
             size = 2.5) +
  scale_color_manual(values = method_grays, labels = method_labels) +
  scale_shape_manual(values = method_shapes, labels = method_labels) + 
  guides(
    color = guide_legend(title = "Rating Method"),
    shape = guide_legend(title = "Rating Method")) +
  
  labs(
    x = "Entry", 
    y = "Disease severity (%)",
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(
      hjust = 0.5, 
      size = 12), # main title 
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1,
      size = 4,
      color = "black"
    ),
    axis.title = element_text(size = 12), # axis title 
    legend.position = c(0, 1),
    legend.justification = c("left", "top"),
    legend.box.just = "left",
    legend.margin = margin(4, 4, 4, 4), #20, 10, 10, 20
    legend.key.size = unit(0.35, "cm"), #0.5 for own
    legend.title = element_text(size = 9), #11
    legend.text = element_text(size = 8), #10
    legend.spacing.y = unit(0.1, "cm"), #new
  ) +
  ylim(0, 100)
plot(all_ratings_plot)

#Save Plot: 
#ggsave("8dpi/Figures/All_rating_methods_8dpi.tiff", plot = all_ratings_plot,dpi = 600, width = 6.5, height = 4.5, units = "in", compression = "lzw")
```

## Correlation among rating methods (raw data)

-   quantify agreement among phentoyping methods using observed values

```{r, warning = FALSE}
merged_df <- BB_df %>%
  select(Accession, Rep, Blackbird = X8dpi) %>%
  left_join(plot_df %>% select(Accession, Rep, Plot = X8dpi),
            by = c("Accession", "Rep")) %>%
  left_join(detached_df %>% select(Accession, Rep, Detached = X8dpi),
            by = c("Accession", "Rep"))

cor_matrix <- cor(
  merged_df[, c("Blackbird", "Plot", "Detached")],
  use = "pairwise.complete.obs"
)

cor_matrix
```


### Plot Correlations

```{r, message = FALSE}
# Load per-accession mean severity
bb <- read_csv("8dpi/BB_Dunnett.csv") %>%
 select(Accession, BB = X8dpi_mean)

plot_eye <- read_csv("8dpi/Plot_Dunnett.csv") %>%
  select(Accession, Plot = X8dpi_mean)

detached <- read_csv("8dpi/Detached_Dunnett.csv") %>%
  select(Accession, Detached = X8dpi_mean)

# Merge into one wide dataframe
corr_df <- bb %>%
  inner_join(plot_eye, by = "Accession") %>%
  inner_join(detached, by = "Accession")
```

```{r}
plot_corr <- function(df, x, y, xlab, ylab) {

  r_val <- cor(df[[x]], df[[y]], use = "complete.obs")

  ggplot(df, aes(x = .data[[x]], y = .data[[y]])) +
    geom_point(color = "gray30", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 0.8) +
    scale_x_continuous(limits = c(0, 100), expand = c(0, 0)) +
    scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
    coord_fixed() +
    annotate(
      "text",
      x = Inf, y = -Inf,
      label = paste0("r = ", round(r_val, 2)),
      hjust = 1.1, vjust = -0.5,
      size = 4
    ) +
    labs(x = xlab, y = ylab) +
    theme_classic()
}

p_bb_plot <- plot_corr(
  corr_df,
  "BB", "Plot",
  "Blackbird severity (%)",
  "Leaf disc severity (%)"
)

p_bb_detached <- plot_corr(
  corr_df,
  "BB", "Detached",
  "Blackbird severity (%)",
  "Detached severity (%)"
)

p_plot_detached <- plot_corr(
  corr_df,
  "Plot", "Detached",
  "Leaf disc severity (%)",
  "Detached severity (%)"
)
```

```{r}
# Put into a four panel figure 
library(patchwork)

final_fig4 <-
  all_ratings_plot +
  (p_bb_plot | p_bb_detached | p_plot_detached) +
  plot_layout(heights = c(1.2, 1)) +
  plot_annotation(tag_levels = "A")

final_fig4

ggsave("8dpi/Figures/Method_Correlations.tiff",plot = final_fig4,dpi = 600, width = 7.5,height = 6, units = "in",compression = "lzw")
```

# Comparison of rating methods

```{r}
# Combine methods into a single data set 
comparison_long <- BB_df %>%
  select(Accession, Batch, Rep, BB = aX8dpi) %>%
  inner_join(plot_df %>% select(Accession, Batch, Rep, Plot = aX8dpi),
             by = c("Accession", "Batch", "Rep")) %>%
  inner_join(detached_df %>% select(Accession, Batch, Rep, Detached = aX8dpi),
             by = c("Accession", "Batch", "Rep")) %>%
  pivot_longer(cols = c(BB, Plot, Detached),
               names_to = "method",
               values_to = "severity")
```

## Severity estimate differences

```{r, message = FALSE}
library(multcomp)
```

```{r}
comparison_long$method <- factor(
  comparison_long$method,
  levels = c("BB", "Plot", "Detached")
)

rat_method <- lme(
  severity ~ method,
  random = list(
    Accession = ~1, 
    Batch = ~1, 
    Rep = ~1 | Batch),
  data = comparison_long,
  method = "REML"
)
# residual SD will differ by method instead of severity class 

emm_method <- emmeans(rat_method, ~ method)
cld(emm_method, adjust = "tukey")
```

-   Detached leaves = 0.310 (lowest severity estimates) |  SE 0.0264 | 0.247 to 0.374
-   Blackbird = 0.389 (intermediate) | SE 0.264 | 0.325 to 0.453
-   Leaf disc = 0.497 (highest) SE 0.0264 | 0.433 to 0.561

Answers the question --> do rating methods differ in mean severity estimates, accounting for accession, batch, and rep, allowing method specific residual variance

## Residual variance/ consistency differences

```{r}
# LMMs
# BB
bb_mod <- lme(
  aX8dpi ~ Accession,
  random = list(
    Batch = ~1, 
    Rep = ~1 | Batch), # rep nested in Batch
  data = BB_df,
  method = "REML"
)

# plot
plot_mod <- lme(
  aX8dpi ~ Accession,
  random = list(
    Batch = ~1, 
    Rep = ~1 | Batch), 
  data = plot_df,
  method = "REML"
)

# detached
detached_mod <- lme(
  aX8dpi ~ Accession,
  random = list(
    Batch = ~1, 
    Rep = ~1 | Batch),
  data = detached_df,
  method = "REML"
)
```


```{r}
# Extract residual SDs from per-method LMMs
resid_var_table <- tibble(
  Method = c("BB", "Plot", "Detached"),
  Residual_SD = c(
    summary(bb_mod)$sigma,
    summary(plot_mod)$sigma,
    summary(detached_mod)$sigma
  )
) %>%
  mutate(Residual_Variance = Residual_SD^2)

resid_var_table
```

Residual standard dev. are relative indicators of consistency across methods rather than absolute variance estimates

- Blackbird: 0.053  --> most consistent 
- Detached: 0.061 --> moderately consistent
- Leaf disc: 0.091 --> least consistent 

