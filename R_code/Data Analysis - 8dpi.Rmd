---
title: "2024 Hemp Downy Mildew Experiment 8dpi Analysis"
author: "Taylere Herrmann"
date: "`r Sys.Date()`"
output: html_document
---

```{r, message=FALSE}
# Loading additional libraries:
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(car)
```

# Data preprocessing

```{r}
# Import dataset
df <- read.csv("Full_dataset.csv", na.strings = ".")
```


```{r}
# rename accession with proper cultivar names:
# list accession numbers and their corresponding cultivar names 
name_map <- c(
  "G33203" = "Cherry Wine",
  "G33208" = "Magic Bullet 5",
  "G33209" = "Spectrum",
  "G33236" = "FL 58",
  "G33294" = "BaOx",
  "G33314" = "AC/DC",
  "G33315" = "Otto II",
  "G33337" = "Tisza",
  "G33341" = "Tiborszallasi",
  "G33344" = "Blue Kross",
  "G33365" = "Queen Dream",
  "G33368" = "Henola",
  "G33370" = "SS Beta",
  "G33371" = "Bialobrzeskie",
  "G33376" = "Fibror 79",
  "G33379" = "Santhica 27",
  "G33380" = "Santhica 70",
  "G33382" = "PhotoCBD",
  "G33534" = "G33534 23UO SD",
  "G33574" = "Ursa® 'Grande'",
  "G33575" = "Ursa® 'Alta'",
  "G33580" = "TJs CBD",
  "G33591" = "USO 31",
  "G33592" = "Carmagnola",
  "G33650" = "CFX-2",
  "GVA-H-20-1144" = "Sweet Caroline",
  "G33571" = "GVA-H-21-1077",
  "G33573" = "GVA-H-22-1166",
  "G33576" = "GVA-H-23-1142")

#Turn the named vector into a dataframe for joining
name_map_df <- tibble(
  Accession = names(name_map),
  Cultivar = unname(name_map)
)

# Join and overwrite Accession values with cultivar names where available
df <- df %>%
  left_join(name_map_df, by = "Accession") %>%
  mutate(Accession = if_else(!is.na(Cultivar), Cultivar, Accession)) %>%
  select(-Cultivar)  # optional: remove the now-unnecessary column
```

## Blackbird

```{r}
# Filter for Blackbird ratings and calculate averages:
BB_df <- df %>% 
  filter(Rating =="Blackbird", Isolate == 22031) %>% 
  #mutate(Accession = gsub("^G(?=\\d)", "G ", Accession, perl = TRUE)) %>%  # Add space after G
  group_by(Accession, Rep) %>% 
  summarise(across(c("X0dpi", "X5dpi", "X6dpi", "X7dpi", "X8dpi", "X9dpi"), 
                   ~round(mean(.x, na.rm = TRUE), 1)))

# Saving Blackbird (BB) averaged (1 value per 5 disc plot) data to its own csv file. 
write_csv(BB_df, file ="BB_average.csv")
```

### Blackbird missing datapoints 

```{r}
library(tidyverse)
df <- read.csv("Full_dataset.csv", na.strings = ".")

BB_df <- df %>% 
  filter(Rating == "Blackbird")

dpi_cols <- c("X5dpi", "X6dpi", "X7dpi", "X8dpi", "X9dpi")

# Convert dpi columns to numeric (forces any remaining "." or invalid entries to NA)
BB_df[dpi_cols] <- lapply(BB_df[dpi_cols], as.numeric)

# Count missing values per dpi
na_per_dpi <- sapply(BB_df[dpi_cols], function(x) sum(is.na(x)))
print("Number of missing values per dpi:")
print(na_per_dpi)

# Count total missing values across 5–9 dpi
total_na <- sum(is.na(BB_df[dpi_cols]))
cat("Total missing values across 5–9 dpi:", total_na, "\n")

# Number of expected data points at a given dpi
cat("the number of datapoints in a given dpi is:", nrow(BB_df))
```

## Leaf disc (labeled plot)

```{r}
# Leaf disc rating by eye dataframe and csv
plot_df <- df %>% 
  filter(Rating == "Plot", Isolate == 22031) %>% 
  group_by(Accession, Rep) %>% 
  summarise(across(c("X0dpi", "X5dpi", "X6dpi", "X7dpi", "X8dpi", "X9dpi"), 
                   ~round(mean(.x, na.rm = TRUE), 1)))

# Save csv file
write_csv(plot_df, file ="Plot_average.csv")
```

## Detached leaf

```{r}
# Detached leaf assay dataframe and csv
detached_df <- df %>% 
  filter(Rating == "Detached", Isolate == 22031) %>% 
  group_by(Accession, Rep) %>% 
  summarise(across(c("X0dpi", "X5dpi", "X6dpi", "X7dpi", "X8dpi", "X9dpi"), 
                    ~round(mean(.x, na.rm = TRUE), 1)))
  # Rounded to one decimal place

# Save csv file 
write_csv(detached_df, file ="Detached_average.csv")
```

------------------------------------------------------------------------

# Blackbird Neural Network Rating - 8dpi

## Transformation

```{r}
BB_df <- read_csv("BB_average.csv")

#Arcsine transformation:
BB_df <- BB_df %>% 
  mutate(across(c(X0dpi, X5dpi, X6dpi, X7dpi, X8dpi, X9dpi), 
                ~asin(sqrt(.x/100)), 
                .names = "a{.col}")) #transformed columns have an "a" infront

# Save as a .csv (helpful for later)
write_csv(BB_df, file ="BB_transformed.csv")

# Calculate mean and standard error for each timepoint by accession for raw (nontransformed) data
BB_summary <- BB_df %>% 
  group_by(Accession) %>% 
  summarise(across (starts_with("X"),
                    list(mean = ~round(mean(.x, na.rm = TRUE), 4),
                         stderr = ~round(sd(.x, na.rm = TRUE)/ sqrt(n()), 4)), 
                    .names = "{.col}_{.fn}"))

# Make a separate data frame with just 8dpi info
BB_8dpi_summary <- BB_summary %>%
  select(Accession, X8dpi_mean, X8dpi_stderr)

```

## Linear Mixed Model

```{r}
#linear mixed model
model <- lmer(aX8dpi ~ Accession + (1 | Rep), data = BB_df)

summary(model) 

#lsmeans
lsmeans_results <- emmeans(model, ~ Accession)
```

## Dunnett - Post Hoc

```{r}
# Dunnett's test with only G33312, a high severity accession
dunnett_G33312 <- contrast(lsmeans_results, method = "dunnett", ref = c("G33312"), adjust = "none")

# Convert results to a dataframe:
dunnett_G33312_df <- as.data.frame(dunnett_G33312)

# Filter for significant pvalues (p<0.05)
sig_G33312 <- dunnett_G33312_df %>% 
  filter(p.value <= 0.05)

# Count the number of significant pvalues
sig_G33312_count <- nrow(sig_G33312)

# Print the number of significant p-values
print(paste("The number of accessions that have significanlty less disease than the susceptible control is:", sig_G33312_count))
```

```{r}
# Make a new dataframe denoting which accession comparisons are significant, and which are not
dunnett_G33312_df <- dunnett_G33312_df %>%
  mutate(
    significant = ifelse(p.value <= 0.05, "Yes", "No"),
    Accession = str_remove(contrast, " - G33312"),
    Reference = "G33312"
  ) %>%
  select(-estimate, -SE, -df, -t.ratio, -contrast)
```

```{r}
# Dunnett's test with only G33379, a low severity accession
dunnett_G33379<- contrast(lsmeans_results, method = "dunnett", ref = c("Santhica 27"), adjust = "none")

# Convert results to a dataframe:
dunnett_G33379_df <- as.data.frame(dunnett_G33379)

# Filter for significant pvalues (p<0.05)
sig_G33379 <- dunnett_G33379_df %>% 
  filter(p.value <= 0.05)

# Count the number of significant pvalues
sig_G33379_count <- nrow(sig_G33379)

# Print the number of significant p-values
print(paste("The number of accessions that have significanlty more disease than the resistant control is:", sig_G33379_count))
```

## Organizing Dunnett data

```{r}
# Make a new dataframe denoting which accession comparisons are significant, and which are not
dunnett_G33379_df <- dunnett_G33379_df %>%
  mutate(
    significant = ifelse(p.value <= 0.05, "Yes", "No"),
    Accession = str_remove(contrast, " - Santhica 27"),
    Reference = "Santhica 27"
  ) %>%
  select(-estimate, -SE, -df, -t.ratio, -contrast)
```


```{r}
#normalize accession column across all data frames 
clean_accession <- function(x) {
  x %>%
    str_trim() %>%                  # remove leading/trailing spaces
    str_remove_all("\\(|\\)")       # strip parentheses
}

# Apply to all relevant dataframes
BB_8dpi_summary <- BB_8dpi_summary %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33312_df <- dunnett_G33312_df %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33379_df <- dunnett_G33379_df %>%
  mutate(Accession = clean_accession(Accession))
```


```{r}
# Merge data - 8dpi mean and standard error (BB_8dpi_summary) with Dunnett pvalues from G33312 

# Dataframes weren't merging properly so first need to trim white space
BB_8dpi_summary$Accession <- trimws(BB_8dpi_summary$Accession)
dunnett_G33312_df$Accession <- trimws(dunnett_G33312_df$Accession)

# Leftjoin with accession  
merged_df <- BB_8dpi_summary %>%
  left_join(dunnett_G33312_df, by = "Accession")

# Edit merged df column names
merged_df <- merged_df %>% 
  select (-Reference) %>% 
  rename(G33312_p.value = p.value, G33312_significant = significant)
```

```{r}
# Merge dunnett_G33379_df in with new merged dataframe (8dpi mean and std error and G33312)

# Dataframes weren't merging properly so first need to trim white space
dunnett_G33379_df$Accession <- trimws(dunnett_G33379_df$Accession)

# Leftjoin with accession  
merged_df_full <- merged_df %>%
  left_join(dunnett_G33379_df, by = "Accession")

# Edit merged column names for clarity
merged_df_BB <- merged_df_full %>% 
  select (-Reference) %>% 
  rename(G33379_p.value = p.value, G33379_significant = significant)

# Round mean and error to 2 decimal places, and p.values to 3 decimal places 
merged_df_BB <- merged_df_BB %>%
  mutate(across(c(X8dpi_mean, X8dpi_stderr), round, 2)) %>%
  mutate(across(c(G33312_p.value, G33379_p.value), round, 3))
```

```{r}
# Saving Blackbird merged Dunnett results 
write_csv(merged_df_BB, file = "8dpi/BB_Dunnett.csv")
```

## BLUP calculation (best linear unbiased prediction, 8dpi on arcsin transformed data)

```{r}
# Fit the LMM for arcsine-transformed data
bb_blup_model <- lmer(aX8dpi ~ 1 + 
                     (1|Accession) + 
                     (1|Rep), 
                   data = BB_df)

# Extract BLUPs for Accession
blup_df <- ranef(bb_blup_model)$Accession %>%
  as.data.frame() %>%
  rename(blup_aX8dpi = `(Intercept)`) %>%
  mutate(Accession = rownames(ranef(bb_blup_model)$Accession))

# Calculate per-accession means
summary_means <- BB_df %>%
  group_by(Accession) %>%
  summarise(
    mean_X8dpi = mean(X8dpi, na.rm = TRUE),
    mean_aX8dpi = mean(aX8dpi, na.rm = TRUE)
  )

# Combine means and BLUPs
blup_summary <- summary_means %>%
  left_join(blup_df, by = "Accession") %>%
  dplyr::select(Accession, mean_X8dpi, mean_aX8dpi, blup_aX8dpi)

# Export to CSV
write.csv(blup_summary, "8dpi/BB_BLUP.csv", row.names = FALSE)

# Rank accessions by BLUP (lower BLUP = more resistant)
blup_ranked <- blup_summary %>%
  arrange(blup_aX8dpi) %>%
  mutate(Rank = row_number())

#Export ranked table
#write.csv(blup_ranked, "8dpi/BB_BLUP_ranked.csv", row.names = FALSE)
```

## Visualize Susceptible Control Significance (G33312, 8dpi)

```{r,warning = FALSE}
# Load the data
df_fig1 <- read.csv("8dpi/BB_Dunnett.csv")

# Categorize bars for coloring
df_fig1 <- df_fig1 %>%
  mutate(Group = case_when(
    G33312_significant == "Yes" ~ "Significant",
    TRUE ~ "Not significant"
  ))

# Reorder legend
df_fig1$Group <- factor(df_fig1$Group, levels = c("Significant", "Not significant"))

# Order bars by mean severity
df_fig1 <- df_fig1 %>% arrange(X8dpi_mean)

# Define fill color
fill_colors <- c("Significant" = "#7C6BAF", "Not significant" = "#D9D9D9")
 #old sig colors #4C8C8A not sig gray
# Plot
p1 <- ggplot(df_fig1, aes(x = reorder(Accession, X8dpi_mean), y = X8dpi_mean, fill = Group)) +
  geom_bar(stat = "identity", alpha = 0.80) +
  geom_errorbar(aes(ymin = X8dpi_mean - X8dpi_stderr, ymax = X8dpi_mean + X8dpi_stderr), 
                width = 0.3, 
                color = "#000000", #could use grey30 or #1A1A1A
                alpha = 0.6) + #changes the color of the errorbars 
  scale_fill_manual(
    values = fill_colors, 
    labels = c("Significant" = "Significantly Less Disease", 
             "Not significant" = "No Significant Difference")
) +
  theme_classic() +
  theme(
    plot.title = element_text(
      hjust = 0.5, 
      size = 12),
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1,
      size = 4,
      color = "black" #all labels in black 
    ),
    axis.title = element_text(size = 12), # axis title 
    legend.position = c(0, 1),
    legend.justification = c("left", "top"),
    legend.box.just = "left",
    legend.margin = margin(20, 10, 10, 20), 
    legend.key.size = unit(0.5, "cm"), 
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  ) +
  labs(
    x = "Entry",
    y = "Disease Severity (0–100%)",
    fill = "Statistical Difference from Susceptible Control"
  ) +
  ylim(0, 100)

#put in arrow
# Get the x-position of G33312
g33312_index <- which(levels(reorder(df_fig1$Accession, df_fig1$X8dpi_mean)) == "G33312")

# Add arrow far above the bar
p1 <- p1 +
  annotate("segment",
           x = g33312_index, xend = g33312_index,
           y = 96, yend = 86,  # place arrow well above y-axis limit
           arrow = arrow(length = unit(0.2, "cm")),
           color = "black")
plot(p1)

ggsave("8dpi/Figures/Blackbird_8dpi.tiff", plot = p1,dpi = 600,width = 6.5, height = 4.5, units = "in", compression = "lzw")     # APS requires LZW compression
```

------------------------------------------------------------------------

# Leaf Disc Plot Rating by Eye - 8dpi

## Transformation

```{r}
plot_df <- read_csv("Plot_average.csv")

plot_df <- plot_df %>% 
  mutate(across(c(X0dpi, X5dpi, X6dpi, X7dpi, X8dpi, X9dpi), 
                ~asin(sqrt(.x/100)), 
                .names = "a{.col}")) #transformed columns have an "a" infront

# Save as a .csv (helpful for later)
write_csv(plot_df, file ="plot_transformed.csv")

# Calculate mean and standard error for each timepoint by accession (for raw data)
plot_summary <- plot_df %>% 
  group_by(Accession) %>% 
  summarise(across (starts_with("X"),
                    list(mean = ~round(mean(.x, na.rm = TRUE), 4),
                         stderr = ~round(sd(.x, na.rm = TRUE)/ sqrt(n()), 4)), 
                    .names = "{.col}_{.fn}"))

# Make a separate data frame with just 8dpi info
plot_8dpi_summary <- plot_summary %>%
  select(Accession, X8dpi_mean, X8dpi_stderr)

```

## Linear Mixed Model

```{r}
#linear mixed model
model <- lmer(aX8dpi ~ Accession + (1 | Rep), data = plot_df)

summary(model) 

#least squared means
lsmeans_results <- emmeans(model, ~ Accession)
```

## Dunnett - Post Hoc

```{r}
# Dunnett's test with only G33312, a high severity accession
dunnett_G33312 <- contrast(lsmeans_results, method = "dunnett", ref = c("G33312"), adjust = "none")

# Convert results to a dataframe:
dunnett_G33312_df <- as.data.frame(dunnett_G33312)

# Filter for significant pvalues (p<0.05)
sig_G33312 <- dunnett_G33312_df %>% 
  filter(p.value <= 0.05)

# Count the number of significant pvalues
sig_G33312_count <- nrow(sig_G33312)

# Print the number of significant p-values
print(paste("The number of accessions that have significanlty less disease than the susceptible control is:", sig_G33312_count))
```

```{r}
# Make a new dataframe denoting which accession comparisons are significant, and which are not
dunnett_G33312_df <- dunnett_G33312_df %>%
  mutate(
    significant = ifelse(p.value <= 0.05, "Yes", "No"),
    Accession = str_remove(contrast, " - G33312"),
    Reference = "G33312"
  ) %>%
  select(-estimate, -SE, -df, -t.ratio, -contrast)
```

```{r}
# Dunnett's test with only G33379, a low severity accession
dunnett_G33379<- contrast(lsmeans_results, method = "dunnett", ref = c("Santhica 27"), adjust = "none")

# Convert results to a dataframe:
dunnett_G33379_df <- as.data.frame(dunnett_G33379)

# Filter for significant pvalues (p<0.05)
sig_G33379 <- dunnett_G33379_df %>% 
  filter(p.value <= 0.05)

# Count the number of significant pvalues
sig_G33379_count <- nrow(sig_G33379)

# Print the number of significant p-values
print(paste("The number of accessions that have significanlty more disease than the resistant control is", sig_G33379_count))
```

## Organizing Dunnett Data

```{r}
# Make a new dataframe denoting which accession comparisons are significant, and which are not
dunnett_G33379_df <- dunnett_G33379_df %>%
  mutate(
    significant = ifelse(p.value <= 0.05, "Yes", "No"),
    Accession = str_remove(contrast, " - Santhica 27"),
    Reference = "Santhica 27"
  ) %>%
  select(-estimate, -SE, -df, -t.ratio, -contrast)
```

```{r}
#normalize accession column across all data frames 
clean_accession <- function(x) {
  x %>%
    str_trim() %>%                  # remove leading/trailing spaces
    str_remove_all("\\(|\\)")       # strip parentheses
}

# Apply to all relevant dataframes
plot_8dpi_summary <- plot_8dpi_summary %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33312_df <- dunnett_G33312_df %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33379_df <- dunnett_G33379_df %>%
  mutate(Accession = clean_accession(Accession))
```

```{r}
# Merge data - 8dpi mean and standard error (plot_8dpi_summary) with Dunnett pvalues from G33312 

# Dataframes weren't merging properly so first need to trim white space
plot_8dpi_summary$Accession <- trimws(plot_8dpi_summary$Accession)
dunnett_G33312_df$Accession <- trimws(dunnett_G33312_df$Accession)

# Leftjoin with accession  
merged_df <- plot_8dpi_summary %>%
  left_join(dunnett_G33312_df, by = "Accession")

merged_df <- merged_df %>% 
  select (-Reference) %>% 
  rename(G33312_p.value = p.value, G33312_significant = significant)
```

```{r}
# Merge dunnett_G33379_df in with new merged dataframe (8dpi mean and std error and G33312)

# Dataframes weren't merging properly so first need to trim white space
dunnett_G33379_df$Accession <- trimws(dunnett_G33379_df$Accession)

# Leftjoin with accession  
merged_df_full <- merged_df %>%
  left_join(dunnett_G33379_df, by = "Accession")

# Edit merged column names for clarity
merged_df_plot <- merged_df_full %>% 
  select (-Reference) %>% 
  rename(G33379_p.value = p.value, G33379_significant = significant)

# Round mean and error to 2 decimal places, and p.values to 3 decimal places 
merged_df_plot <- merged_df_plot %>%
  mutate(across(c(X8dpi_mean, X8dpi_stderr), round, 2)) %>%
  mutate(across(c(G33312_p.value, G33379_p.value), round, 3))
```

```{r}
# Saving Blackbird merged Dunnett results 
write_csv(merged_df_plot, file = "8dpi/Plot_Dunnett.csv")
```

## BLUP calculation (best linear unbiased prediction, 8dpi on arcsin transformed data)

```{r}
# Fit the LMM for arcsine-transformed data
plot_blup_model <- lmer(aX8dpi ~ 1 + 
                     (1|Accession) + 
                     (1|Rep), 
                   data = plot_df)

# Extract BLUPs for Accession
blup_df <- ranef(plot_blup_model)$Accession %>%
  as.data.frame() %>%
  rename(blup_aX8dpi = `(Intercept)`) %>%
  mutate(Accession = rownames(ranef(plot_blup_model)$Accession))

# Calculate per-accession means
summary_means <- plot_df %>%
  group_by(Accession) %>%
  summarise(
    mean_X8dpi = mean(X8dpi, na.rm = TRUE),
    mean_aX8dpi = mean(aX8dpi, na.rm = TRUE)
  )

# Combine means and BLUPs
blup_summary <- summary_means %>%
  left_join(blup_df, by = "Accession") %>%
  dplyr::select(Accession, mean_X8dpi, mean_aX8dpi, blup_aX8dpi)

# Export to CSV
write.csv(blup_summary, "8dpi/Plot_BLUP.csv", row.names = FALSE)

# Rank accessions by BLUP (lower BLUP = more resistant)
blup_ranked <- blup_summary %>%
  arrange(blup_aX8dpi) %>%
  mutate(Rank = row_number())

# Export ranked table
#write.csv(blup_ranked, "8dpi/Plot_BLUP_ranked.csv", row.names = FALSE)
```

## Visualize Susceptible Control Significance (G33312, 8dpi)

```{r,warning = FALSE}
# Load the data
df_fig1 <- read.csv("8dpi/Plot_Dunnett.csv")

# Categorize bars for coloring
df_fig1 <- df_fig1 %>%
  mutate(Group = case_when(
    G33312_significant == "Yes" ~ "Significant",
    TRUE ~ "Not significant"
  ))

# Reorder legend
df_fig1$Group <- factor(df_fig1$Group, levels = c("Significant", "Not significant"))

# Order bars by mean severity
df_fig1 <- df_fig1 %>% arrange(X8dpi_mean)

# Define fill color
fill_colors <- c("Significant" = "#3AAFB9", "Not significant" = "#D9D9D9")

# Plot
p1 <- ggplot(df_fig1, aes(x = reorder(Accession, X8dpi_mean), y = X8dpi_mean, fill = Group)) +
  geom_bar(stat = "identity", alpha = 0.80) +
  geom_errorbar(aes(ymin = X8dpi_mean - X8dpi_stderr, ymax = X8dpi_mean + X8dpi_stderr), 
                width = 0.3, 
                color = "#000000", 
                alpha = 0.6) + #changes the color of the errorbars 
  scale_fill_manual(
    values = fill_colors, 
    labels = c("Significant" = "Significantly Less Disease", 
             "Not significant" = "No Significant Difference")
) +
  theme_classic() +
  theme(
    plot.title = element_text(
      hjust = 0.5, 
      size = 12),
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1,
      size = 4,
      color = "black"
    ),
    axis.title = element_text(size = 12), # axis title 
    legend.position = c(0, 1),
    legend.justification = c("left", "top"),
    legend.box.just = "left",
    legend.margin = margin(20, 10, 10, 20), 
    legend.key.size = unit(0.5, "cm"), 
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  ) +
  labs(
    x = "Entry",
    y = "Disease Severity (0–100%)",
    fill = "Statistical Difference from Susceptible Control"
  ) +
  ylim(0, 100)

#put in arrow
# Get the x-position of G33312
g33312_index <- which(levels(reorder(df_fig1$Accession, df_fig1$X8dpi_mean)) == "G33312")

# Add arrow far above the bar
p1 <- p1 +
  annotate("segment",
           x = g33312_index, xend = g33312_index,
           y = 110, yend = 100,  # place arrow well above y-axis limit
           arrow = arrow(length = unit(0.2, "cm")),
           color = "black")
# Extend the Y axis to accommodate the arrow and keep y axis marks 
p1 <- p1 +
  scale_y_continuous(
    limits = c(0, 110),                  # allows room for the arrow
    breaks = c(0, 25, 50, 75, 100)       # custom tick marks
  )
plot(p1)

ggsave("8dpi/Figures/Leaf_disc_8dpi.tiff", plot = p1,dpi = 600,width = 6.5, height = 4.5, units = "in", compression = "lzw")     # APS requires LZW compression
```

------------------------------------------------------------------------

# Detached Leaf Rating by Eye - 8dpi

## Transformation

```{r}
detached_df <- read_csv("Detached_average.csv")

detached_df <- detached_df %>% 
  mutate(across(c(X0dpi, X5dpi, X6dpi, X7dpi, X8dpi, X9dpi), 
                ~asin(sqrt(.x/100)), 
                .names = "a{.col}")) #transformed columns have an "a" infront

# Save as a .csv (helpful for later)
write_csv(detached_df, file ="detached_transformed.csv")

# Calculate mean and standard error for each timepoint by accession
detached_summary <- detached_df %>% 
  group_by(Accession) %>% 
  summarise(across (starts_with("X"),
                    list(mean = ~round(mean(.x, na.rm = TRUE), 4),
                         stderr = ~round(sd(.x, na.rm = TRUE)/ sqrt(n()), 4)), 
                    .names = "{.col}_{.fn}"))

# Make a separate data frame with just 8dpi info
detached_8dpi_summary <- detached_summary %>%
  select(Accession, X8dpi_mean, X8dpi_stderr)
```

## Linear Mixed Model

```{r}
#linear mixed model 
model <- lmer(aX8dpi ~ Accession + (1 | Rep), data = detached_df)

summary(model) 

#lsmeans
lsmeans_results <- emmeans(model, ~ Accession)
```

## Dunnett - Post Hoc

```{r}
# Dunnett's test with only G33312, a high severity accession
dunnett_G33312 <- contrast(lsmeans_results, method = "dunnett", ref = c("G33312"), adjust = "none")

# Convert results to a dataframe:
dunnett_G33312_df <- as.data.frame(dunnett_G33312)

# Filter for significant pvalues (p<0.05)
sig_G33312 <- dunnett_G33312_df %>% 
  filter(p.value <= 0.05)

# Count the number of significant pvalues
sig_G33312_count <- nrow(sig_G33312)

# Print the number of significant p-values
print(paste("The number of accessions that have significanlty less disease than the susceptible control is:", sig_G33312_count))
```

```{r}
# Make a new dataframe denoting which accession comparisons are significant, and which are not
dunnett_G33312_df <- dunnett_G33312_df %>%
  mutate(
    significant = ifelse(p.value <= 0.05, "Yes", "No"),
    Accession = str_remove(contrast, " - G33312"),
    Reference = "G33312"
  ) %>%
  select(-estimate, -SE, -df, -t.ratio, -contrast)
```

```{r}
# Dunnett's test with only G33379, a low severity accession
dunnett_G33379<- contrast(lsmeans_results, method = "dunnett", ref = c("Santhica 27"), adjust = "none")

# Convert results to a dataframe:
dunnett_G33379_df <- as.data.frame(dunnett_G33379)

# Filter for significant pvalues (p<0.05)
sig_G33379 <- dunnett_G33379_df %>% 
  filter(p.value <= 0.05)

# Count the number of significant pvalues
sig_G33379_count <- nrow(sig_G33379)

# Print the number of significant p-values
print(paste("The number of accessions that have significanlty more disease than the resistant control is:", sig_G33379_count))
```

## Organizing Dunnett Data

```{r}
#Make a new dataframe denoting which accession comparisons are significant, and which are not
dunnett_G33379_df <- dunnett_G33379_df %>%
  mutate(
    significant = ifelse(p.value <= 0.05, "Yes", "No"),
    Accession = str_remove(contrast, " - Santhica 27"),
    Reference = "Santhica 27"
  ) %>%
  select(-estimate, -SE, -df, -t.ratio, -contrast)
```

```{r}
# Normalize accession column across all data frames 
clean_accession <- function(x) {
  x %>%
    str_trim() %>%                  # remove leading/trailing spaces
    str_remove_all("\\(|\\)")       # strip parentheses
}

# Apply to all relevant dataframes
detached_8dpi_summary <- detached_8dpi_summary %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33312_df <- dunnett_G33312_df %>%
  mutate(Accession = clean_accession(Accession))

dunnett_G33379_df <- dunnett_G33379_df %>%
  mutate(Accession = clean_accession(Accession))
```

```{r}
# Merge data - 8dpi mean and standard error (detached_8dpi_summary) with Dunnett pvalues from G33312 

# Dataframes weren't merging properly so first need to trim white space
detached_8dpi_summary$Accession <- trimws(detached_8dpi_summary$Accession)
dunnett_G33312_df$Accession <- trimws(dunnett_G33312_df$Accession)

# Leftjoin with accession  
merged_df <- detached_8dpi_summary %>%
  left_join(dunnett_G33312_df, by = "Accession")

# Edit merged df column names
merged_df <- merged_df %>% 
  select (-Reference) %>% 
  rename(G33312_p.value = p.value, G33312_significant = significant)
```

```{r}
# Merge dunnett_G33379_df in with new merged dataframe (8dpi mean and std error and G33312)

# Dataframes weren't merging properly so first need to trim white space
dunnett_G33379_df$Accession <- trimws(dunnett_G33379_df$Accession)

# Leftjoin with accession  
merged_df_full <- merged_df %>%
  left_join(dunnett_G33379_df, by = "Accession")

# Edit merged column names for clarity
merged_df_detached <- merged_df_full %>% 
  select (-Reference) %>% 
  rename(G33379_p.value = p.value, G33379_significant = significant)

# Round mean and error to 2 decimal places, and p.values to 3 decimal places 
merged_df_detached <- merged_df_detached %>%
  mutate(across(c(X8dpi_mean, X8dpi_stderr), round, 2)) %>%
  mutate(across(c(G33312_p.value, G33379_p.value), round, 3))
```

```{r}
# Saving Blackbird merged Dunnett results 
write_csv(merged_df_detached, file = "8dpi/Detached_Dunnett.csv")
```

## BLUP calculation (best linear unbiased prediction, 8dpi on arcsin transformed data)

## Detached Leaf (detached) - blup

```{r}
# Fit the LMM for arcsine-transformed data
detached_blup_model <- lmer(aX8dpi ~ 1 + 
                     (1|Accession) + 
                     (1|Rep), 
                   data = detached_df)

# Extract BLUPs for Accession
blup_df <- ranef(detached_blup_model)$Accession %>%
  as.data.frame() %>%
  rename(blup_aX8dpi = `(Intercept)`) %>%
  mutate(Accession = rownames(ranef(detached_blup_model)$Accession))

# Calculate per-accession means
summary_means <- detached_df %>%
  group_by(Accession) %>%
  summarise(
    mean_X8dpi = mean(X8dpi, na.rm = TRUE),
    mean_aX8dpi = mean(aX8dpi, na.rm = TRUE)
  )

# Combine means and BLUPs
blup_summary <- summary_means %>%
  left_join(blup_df, by = "Accession") %>%
  dplyr::select(Accession, mean_X8dpi, mean_aX8dpi, blup_aX8dpi)

# Export to CSV
write.csv(blup_summary, "8dpi/Detached_BLUP.csv", row.names = FALSE)

# Rank accessions by BLUP (lower BLUP = more resistant)
blup_ranked <- blup_summary %>%
  arrange(blup_aX8dpi) %>%
  mutate(Rank = row_number())

# Export ranked table
#write.csv(blup_ranked, "8dpi/Detached_BLUP_ranked.csv", row.names = FALSE)
```

## Visualize Susceptible Control Significance (G33312, 8dpi)

```{r,warning = FALSE}
# Load the data
df_fig1 <- read.csv("8dpi/Detached_Dunnett.csv")

# Categorize bars for coloring
df_fig1 <- df_fig1 %>%
  mutate(Group = case_when(
    G33312_significant == "Yes" ~ "Significant",
    TRUE ~ "Not significant"
  ))

# Reorder legend
df_fig1$Group <- factor(df_fig1$Group, levels = c("Significant", "Not significant"))

# Order bars by mean severity
df_fig1 <- df_fig1 %>% arrange(X8dpi_mean)

# Define fill color
fill_colors <- c("Significant" = "#D8817A", "Not significant" = "#D9D9D9")

# Plot
p1 <- ggplot(df_fig1, aes(x = reorder(Accession, X8dpi_mean), y = X8dpi_mean, fill = Group)) +
  geom_bar(stat = "identity", alpha = 0.80) +
  geom_errorbar(aes(ymin = X8dpi_mean - X8dpi_stderr, ymax = X8dpi_mean + X8dpi_stderr), 
                width = 0.3, 
                color = "#000000", 
                alpha = 0.6) + #changes the color of the errorbars 
  scale_fill_manual(
    values = fill_colors, 
    labels = c("Significant" = "Significantly Less Disease", 
             "Not significant" = "No Significant Difference")
) +
  theme_classic() +
  theme(
    plot.title = element_text(
      hjust = 0.5,
      size = 12),
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1,
      size = 4,
      color = "black"
    ),
    axis.title = element_text(size = 12), # axis title 
    legend.position = c(0, 1),
    legend.justification = c("left", "top"),
    legend.box.just = "left",
    legend.margin = margin(20, 10, 10, 20), 
    legend.key.size = unit(0.5, "cm"), 
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  ) +
  labs(
    x = "Entry",
    y = "Disease Severity (0–100%)",
    fill = "Statistical Difference from Susceptible Control"
  ) +
  ylim(0, 100)

#put in arrow
# Get the x-position of G33312
g33312_index <- which(levels(reorder(df_fig1$Accession, df_fig1$X8dpi_mean)) == "G33312")

# Add arrow far above the bar
p1 <- p1 +
  annotate("segment",
           x = g33312_index, xend = g33312_index,
           y = 110, yend = 100,  # place arrow well above y-axis limit
           arrow = arrow(length = unit(0.2, "cm")),
           color = "black")
# Extend the Y axis to accommodate the arrow and keep y axis marks 
p1 <- p1 +
  scale_y_continuous(
    limits = c(0, 110),                  # allows room for the arrow
    breaks = c(0, 25, 50, 75, 100)       # custom tick marks
  )

plot(p1)

ggsave("8dpi/Figures/Detached_8dpi.tiff", plot = p1, dpi = 600,width = 6.5,height = 4.5,units = "in", compression = "lzw")     # APS requires LZW compression
```

------------------------------------------------------------------------

# Rating method comparison:

## Visualize accession by method (Manuscript figure)

```{r,message=FALSE}
# Load Dunnett data
detached <- read_csv("8dpi/Detached_Dunnett.csv")
plot_eye <- read_csv("8dpi/Plot_Dunnett.csv")
bb <- read_csv("8dpi/BB_Dunnett.csv")

# Add a rating method column and extract mean severity at 8dpi
detached <- detached %>%
  select(Accession, X8dpi_mean) %>%
  mutate(Method = "Detached")

plot_eye <- plot_eye %>%
  select(Accession, X8dpi_mean) %>%
  mutate(Method = "Plot")

bb <- bb %>%
  select(Accession, X8dpi_mean) %>%
  mutate(Method = "Blackbird")

# Combine all three datasets
all_data <- bind_rows(detached, plot_eye, bb)
```

```{r}
# Reorder accessions by average severity (low to high)
accession_order <- all_data %>%
  group_by(Accession) %>%
  summarize(avg_severity = mean(X8dpi_mean, na.rm = TRUE)) %>%
  arrange(avg_severity) %>%
  pull(Accession)
    # To organize the accessions by disease severity, the average X8dpi_mean is calculated across all three rating methods for each accession, and accessions are sorted from lowest to highest mean severity 

all_data$Accession <- factor(all_data$Accession, levels = accession_order)

# Legend order 
all_data$Method <- factor(all_data$Method, levels = c("Blackbird", "Plot", "Detached"))

# Legend labels
method_labels <- c(
  "Blackbird" = "Leaf Discs Rated by Blackbird Convolutional Neural Network",
  "Plot" = "Leaf Discs Rated Visually",
  "Detached" = "Detached Leaves Rated Visually")

# colors and point shapes
method_grays <- c(
  "Blackbird" = "#7C6BAF",
  "Plot" = "#3AAFB9",
  "Detached" = "#D8817A")

method_shapes <- c(
   "Blackbird" = 16,
  "Plot" = 17,
  "Detached" = 15) #circle, triangle, square
```

```{r}
# Plot
all_ratings_plot_gray <- ggplot(all_data, aes(x = Accession, y = X8dpi_mean)) +
  geom_line(aes(group = Accession), color = "gray50", size = 0.3, alpha = 0.6) +
  geom_point(aes(color = Method, shape = Method), 
             position = position_dodge(width = 0.5), 
             size = 2.5) +
  scale_color_manual(values = method_grays, labels = method_labels) +
  scale_shape_manual(values = method_shapes, labels = method_labels) + 
  guides(
    color = guide_legend(title = "Rating Method"),
    shape = guide_legend(title = "Rating Method")) +
  
  labs(
    x = "Entry", 
    y = "Disease Severity (0–100%)",
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(
      hjust = 0.5, 
      size = 12), # main title 
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1,
      size = 4,
      color = "black"
    ),
    axis.title = element_text(size = 12), # axis title 
    legend.position = c(0, 1),
    legend.justification = c("left", "top"),
    legend.box.just = "left",
    legend.margin = margin(20, 10, 10, 20),
    legend.key.size = unit(0.5, "cm"),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  ) +
  ylim(0, 100)
plot(all_ratings_plot_gray)

#Save Plot: 
ggsave("8dpi/Figures/All_rating_methods_8dpi.tiff", plot = all_ratings_plot_gray,dpi = 600, width = 6.5, height = 4.5, units = "in", compression = "lzw")
```

## Resistant accessions across methods:
```{r}

# Prepare long-form data for each method

BB_long <- BB_df %>% 
  select(Accession, Rep, X8dpi) %>% 
  rename(BB = X8dpi)

plot_long <- plot_df %>% 
  select(Accession, Rep, X8dpi) %>% 
  rename(Plot = X8dpi)

detached_long <- detached_df %>% 
  select(Accession, Rep, X8dpi) %>% 
  rename(Detached = X8dpi)


# Flag function per method (0%, ≤1%, ≤5%)

flag_method <- function(df, varname) {
  df %>%
    group_by(Accession) %>%
    summarise(
      all_below_5 = all(.data[[varname]] <= 5, na.rm = TRUE),
      all_below_1 = all(.data[[varname]] <= 1, na.rm = TRUE),
      all_zero    = all(.data[[varname]] == 0, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    rename_with(~ paste0(varname, "_", .), -Accession)
}

# Apply flags
BB_flags       <- flag_method(BB_long, "BB")
plot_flags     <- flag_method(plot_long, "Plot")
detached_flags <- flag_method(detached_long, "Detached")

# Merge flags across methods

all_flags <- BB_flags %>%
  full_join(plot_flags, by = "Accession") %>%
  full_join(detached_flags, by = "Accession")


# Summary flags across all methods

final_table <- all_flags %>%
  mutate(
    all_methods_below_5 = BB_all_below_5 & Plot_all_below_5 & Detached_all_below_5,
    all_methods_below_1 = BB_all_below_1 & Plot_all_below_1 & Detached_all_below_1,
    all_methods_zero    = BB_all_zero & Plot_all_zero & Detached_all_zero
  )


# Create named lists of accessions per group

pad_to_length <- function(vec, max_length) {
  length(vec) <- max_length
  return(vec)
}

accession_groups <- list(
  `BB LE5%`        = final_table %>% filter(BB_all_below_5) %>% pull(Accession),
  `Plot LE5%`      = final_table %>% filter(Plot_all_below_5) %>% pull(Accession),
  `Detached LE5%`  = final_table %>% filter(Detached_all_below_5) %>% pull(Accession),
  `BB LE1%`        = final_table %>% filter(BB_all_below_1) %>% pull(Accession),
  `Plot LE1%`      = final_table %>% filter(Plot_all_below_1) %>% pull(Accession),
  `Detached LE1%`  = final_table %>% filter(Detached_all_below_1) %>% pull(Accession),
  `BB 0%`          = final_table %>% filter(BB_all_zero) %>% pull(Accession),
  `Plot 0%`        = final_table %>% filter(Plot_all_zero) %>% pull(Accession),
  `Detached 0%`    = final_table %>% filter(Detached_all_zero) %>% pull(Accession),
  `All methods LE5%` = final_table %>% filter(all_methods_below_5) %>% pull(Accession),
  `All methods LE1%` = final_table %>% filter(all_methods_below_1) %>% pull(Accession),
  `All methods 0%`   = final_table %>% filter(all_methods_zero) %>% pull(Accession)
)

max_len <- max(lengths(accession_groups))

resistant_table <- accession_groups %>%
  map(~ pad_to_length(.x, max_len)) %>%
  as_tibble()

write_csv(resistant_table, "8dpi/Resistant_Entries.csv")
```

```{r}
# Top 5 accessions by average severity

# Compute mean severity per accession
BB_means <- BB_df %>%
  group_by(Accession) %>%
  summarise(BB_mean = mean(X8dpi, na.rm = TRUE), .groups = "drop")

plot_means <- plot_df %>%
  group_by(Accession) %>%
  summarise(Plot_mean = mean(X8dpi, na.rm = TRUE), .groups = "drop")

detached_means <- detached_df %>%
  group_by(Accession) %>%
  summarise(Detached_mean = mean(X8dpi, na.rm = TRUE), .groups = "drop")

all_means <- BB_means %>%
  full_join(plot_means, by = "Accession") %>%
  full_join(detached_means, by = "Accession") %>%
  rowwise() %>%
  mutate(Average_Severity = mean(c(BB_mean, Plot_mean, Detached_mean), na.rm = TRUE)) %>%
  ungroup()

# Get top 5 accessions by average severity
top5_accessions <- all_means %>%
  arrange(desc(Average_Severity)) %>%
  slice_head(n = 5)

write_csv(top5_accessions, "8dpi/Top5_Average_Severity.csv")

```


## Statistical comparison of rating methods:

```{r}
BB_transformed <- read_csv("BB_transformed.csv")
plot_transformed <- read_csv("plot_transformed.csv")
detached_transformed <- read_csv("detached_transformed.csv")

# combine 3 rating methods into one dataframe while retaining rep
BB_8dpi <- BB_transformed %>%
  select(Accession, Rep, aX8dpi) %>%
  rename(BB = aX8dpi)

LD_8dpi <- plot_transformed %>%
  select(Accession, Rep, aX8dpi) %>%
  rename(LD = aX8dpi)

DL_8dpi <- detached_transformed %>%
  select(Accession, Rep, aX8dpi) %>%
  rename(DL = aX8dpi)

# Merge by Accession and Rep
comparison_df <- BB_8dpi %>%
  inner_join(DL_8dpi, by = c("Accession", "Rep")) %>%
  inner_join(LD_8dpi, by = c("Accession", "Rep"))

# Pivot to long format for analysis
comparison_long <- comparison_df %>%
  pivot_longer(cols = c(BB, DL, LD), names_to = "method", values_to = "severity")

```

```{r}
library(car)
library(multcomp)
library(multcompView)

# Ensure factors are correctly set
comparison_long$method <- as.factor(comparison_long$method)
comparison_long$Rep <- as.factor(comparison_long$Rep)
comparison_long$Accession <- as.factor(comparison_long$Accession)

# Fit linear mixed model
lmm <- lmer(severity ~ method + (1 | Rep) + (1 | Accession), data = comparison_long)

# Model summary with Satterthwaite df
summary(lmm)

# Estimated marginal means
emm <- emmeans(lmm, ~ method)

# Pairwise differences + 95% CI (pdiff cl)
pairs(emm, adjust = "tukey")
confint(emm)

# Compact letter display for Tukey
cld(emm, adjust = "tukey")
```

| Method    | Estimated Severity | 95% Confidence interval | Tukey Group |
|-----------|--------------------|-------------------------|-------------|
| Detached  | 0.321              | 0.137 - 0.505           | A           |
| Blackbird | 0.394              | 0.210 - 0.578           | B           |
| Leaf Disc | 0.505              | 0.321 - 0.689           | C           |


## Correlation
```{r}
#Read in dataframes: 
BB_df <- read_csv("BB_average.csv")
plot_df <- read_csv("Plot_average.csv")
detached_df <- read_csv("Detached_average.csv")

#Keep columns of interest and rename 8dpi column 
bb_8dpi <- BB_df %>%
  dplyr::select(Accession, Rep, Blackbird_CNN = X8dpi)

plot_8dpi <- plot_df %>%
  dplyr::select(Accession, Rep, Leaf_disc = X8dpi)

detached_8dpi <- detached_df %>%
  dplyr::select(Accession, Rep, Detached_leaf = X8dpi)

#Join together 
merged_df <- bb_8dpi %>%
  left_join(plot_8dpi, by = c("Accession", "Rep")) %>%
  left_join(detached_8dpi, by = c("Accession", "Rep"))

#Save data sheet so I can look at it:
write_csv(merged_df, file ="Allmethods_reps_8dpi.csv")
```

```{r}
# Pairwise correlations 

cor_matrix <- cor(merged_df[, c("Blackbird_CNN", "Leaf_disc", "Detached_leaf")],
                  use = "pairwise.complete.obs",
                  method = "pearson")  # or "spearman"
cor_matrix
```
BB vs Plot: 0.92 --> very strong correlation
BB vs detached: 0.73 --> strong correlation 
Plot vs Detached: 0.68 --> moderate correlation 

All three rating methods are positively correlated, with the two leaf disc methods agreeing the most. 

```{r}
library(GGally)
ggpairs(merged_df[, c("Blackbird_CNN", "Leaf_disc", "Detached_leaf")])
```

